<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>%%fulltitle%% - Christopher Robison's Blog</title>
  <link rel="canonical" href="https://cdr2.com/crblog/blog/%%name%%.html">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100;200;300;400;500;600;700;800;900&family=Titillium+Web:wght@200;300;400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/crblog/assets/fontawesome-free-6.4.0-web/css/all.min.css">
  <link rel="stylesheet" href="/crblog/assets/css/adminlte.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/sunburst.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
  <style>
    span.required::after {
      display: inline-block;
      position: relative;
      content: "*";
      color: #c00;
      font-size: 1.1rem;
      font-weight: bold;
      height: 2rem;
      width: 2rem;
    }
    section.comments  header {
      font-size:2rem;
      background:#333;
      color: #eee;
      font-weight: bold;
    }
    section.comments {
      width: 50rem;
      margin: 0px auto;
    }
    section.comments .comment-container {
      padding: 1rem;
    }
    .comment-input {
      width: 30rem;
      font-size: 18px;
      height: 2rem;
    }
    .comment-comment {
      width: 40rem;
      height: 6rem;
    }
    .comment-comments {
      padding: 1rem;
    }
    .comment-date {
      font-size: 0.8rem;
      float: right;
    }
    #comment label span {
      display: block;
      width: 7rem;
    }
    @media screen and (max-width: 640px) {
      section.comments {
        width: 100vw;
      }
      .comment-comment { width: 90vw; }
      .comment-input { width: 90vw; }

    }
    p.comment { margin-bottom: 0px; }
    .comment-item {
      list-style-type: none;
      border-top: 0.5rem solid #ccc;
    }
    .comment-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .comments-list { padding: 0; }
    .commenter { color: #000; font-weight: bold; }
    .reply-link { font-size: 0.8rem; color: #000; display: block;text-align:right;}
    .comment-reply { padding: 0 0 0 1rem; }
  </style>
</head>
<body class="hold-transition iframe-mode">
<!-- Site wrapper -->
<div class="wrapper">
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active"><a href="blog/">Blog</a></li>
              <li class="breadcrumb-item active">%%title%%</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="blog">
          <h1 style="font-weight:900;">%%title%%</h1>
          <h3>%%subtitle%%</h3>
          <p style="float:right;"><br><a href="#" class="sharelink" onclick="return share.showlist(event)"><i class="fas fa-share"></i> Share</a></p>
          <p>
            By Christopher Robison<br>
            %%date%%
          </p>
          <hr>
          <img width="640" src="%%hero%%" class="banner-pic"> 
          <hr>
          %%blogpost%%
          <hr>
          <div class="content-footer">
            <a href="%%next_link%%" onclick="if (parent.app.loadTab) return parent.app.loadTab('%%next_link%%', '%%next_title%%', '%%next_name%%', true, event)" class="next-entry latest" style="font-weight:400;float:right;color:#cc04;">(%%next_title%%) Next &gt; </a>
            <a href="%%prev_link%%" onclick="if (parent.app.loadTab) return parent.app.loadTab('%%prev_link%%', '%%prev_shorttitle%%', '%%prev_name%%', true, event)" title="%%prev_fulltitle%%" style="font-weight:400;">&lt; Previous (%%prev_title%%)</a>
        </div>
      </div>
    </section>
    <section class="comments">
      <header>Discussion</header>
      <div class="comment-comments">
        %%comments%%
      </div>
      <hr>
      <div id="comment-form" class="comment-container" data-_parent="1">
        <h3>Leave a Reply</h3>
        <p>Comment? Suggestion? Just plain mad? Why not Leave a comment and let everyone know what you're thinking. Your email address will never be shared or published. Required fields are marked <span style="color:#c00;">*</span></p>
        <hr>
        <form id="comment" onsubmit="app.comment(event);return false" class="form">
          <label for="comment-comment"><span class="required">Comment</span>
            <textarea rows="5" cols="40" class="comment-comment" id="comment-comment" name="comment-comment"></textarea>
          </label>
          <label for="comment-name"><span class="required">Name</span> 
            <input type="text" id="comment-name" name="comment-name" class="comment-input">
          </label>
          <label for="comment-email"><span class="required">Email</span>
            <input type="text" id="comment-email" name="comment-email" class="comment-input">
          </label>
          <label for="comment-website"><span>Website</span>
            <input type="text" id="comment-website" name="comment-website" class="comment-input">
          </label>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <button style="border:1px solid #0009;border-radius:6px;" onclick="app.cancelComment(this, event);return false;">Cancel</button>
            <button style="border:1px solid #0009;border-radius:6px;" onclick="app.postComment(this, event);return false;">Post Comment</button>
          </div>
        </form>
      </div>
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <footer class="main-footer">
    <div class="float-right d-none d-sm-block">
      <strong>Copyright &copy; 2023 <a href="https://cdr2.com">Christopher Robison</a>.</strong> All rights reserved.
    </div>
  </footer>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="/crblog/assets/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/crblog/assets/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="/crblog/assets/js/adminlte.min.js"></script>
<script src="/crblog/share.js"></script>
<script>hljs.highlightAll();</script>
<script>
(function() {
  const $ = str => document.querySelector(str);
  const $$ = str => document.querySelectorAll(str);

  const app = {
    data: {},
    state: {
      loaded: false
    },
    init() {
      let name = location.href.replace(/^.+\//, '').replace(/\.html$/, '');
      console.log(`page name: ${name}`);;
      
      try {
        fetch(`/crblog/blog/comment.php?page=${name}`).then(r=>r.json()).then(data=>{
          app.comments = data;
          console.log(`Retrieved ${name}.json`);
          console.dir(data);
        });
      } catch(e) {
        console.log(`No comments file found for ${name}`);
        console.dir(e);
      }
      app.state.loaded = true;
    },
    mkcomment(obj, key='1', pid='0') {
      let item = `
 <li class='comment-item' data-key='${key}' data-parentid='${pid}'>
  <div class='comment-head'>
      <div class='commenter'>${obj.name}</div><div class='comment-date'>${obj.date}</div>
  </div>
  <p class='comment'>${obj.comment}</p><div class='reply-wrap'><span class='comment-tools'></span> <a class='reply-link' href='#' onclick='app.reply(this, event, "${key}");return false'>Reply â†’</a></div>`;
      return item; 
    },
    fetch(url, callback) {
      fetch(url).then(response=>response.json()).then(data=>{
          app.data = data;
          app.state.loaded = true;
          if (callback && typeof(callback) === "function") {
              callback(data);
          }
      });
    },
    postComment(who, evt) {
      if (evt) {
        evt.stopPropagation();
        evt.preventDefault();
      }
      let tgt;
      if (who) {
        tgt = who.closest("#commentFormWrap");
      }

      if (!tgt) {
        tgt = document.querySelector("#comment-form");
      }

      let pid = tgt.dataset._parent;
      let post = {
        email: tgt.querySelector("#comment-email")?.value,
        name: tgt.querySelector("#comment-name")?.value,
        site: tgt.querySelector("#comment-website")?.value,
        comment: tgt.querySelector("#comment-comment")?.value,
        date: app.getDate()
      };
      
      let pids = pid.split(/\./);
      if (pids.length === 1) {
        let idx = parseInt(pids[0]) - 1;
        ;
        if (!app.comments[idx]) {
          app.comments[idx] = post;
        }
        if (!app.comments[idx].replies) {
          app.comments[idx].replies = [ ];
        }
        post._id = pid + "." + (app.comments[idx].replies.length + 1);
        post._parent = pid;
        app.comments[idx].replies.push(post);
      } else if (pids.length === 2) {
        let idx1 = parseInt(pids[0]) - 1,
            idx2 = parseInt(pids[1]) - 1;

        if (!app.comments[idx1].replies[idx2].replies) {
          app.comments[idx1].replies[idx2].replies = [];
        }

        post._id = pid + "." + (app.comments[idx1].replies[idx2].replies.length + 1);
        post._parent = pid;
        app.comments[idx1].replies[idx2].replies.push(post);
      }
      let page = location.href.replace(/^.*\//, '').replace(/.html/, '');
        fetch("comment.php?page="+page, {
          method: 'POST',
          body: JSON.stringify(post),
          headers: {
            "Content-type": "application/json; charset=UTF-8"
          }
        }).then(resp=>resp.json()).then(data=>{
          app.buildComments(data);
        });
      console.dir(app.comments);
      console.log(`New comment:`);
      console.dir(post);
    },
    buildComments(arr, ul) {
      if (!ul) ul = document.querySelector("ul.comments-list");
      if (!ul) {
        ul = document.createElement("ul");
        ul.className = "comments-list";
        document.querySelector("#comment-comments").append(ul);
      }    
      let out = "";
      for (let i=0; i<arr.length; i++) {
        out += app.mkcomment(arr[i], arr[i]._id, arr[i]._parent);
        if (arr[i].replies) {
          app.buildComment(arr[i].replies); 
        }
        out += `</li>`;
      }
      ul.innerHTML = out;
    },
    findParent(id, tree) {
      for (let k in tree) {
        if (tree[k]._id === id) {
          
        }
      }
    },
    getDate() {
      let now = new Date();
      let hr = now.getHours();
      let xm = "am";

      if (hr > 12) {
        xm = "pm";
        hr -= 12;
      }

      return now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate() + ' ' + hr + ':' + now.getMinutes() + xm;
    },
    reply(who, evt, pid='0') {
      if (evt) {
        evt.stopPropagation();
        evt.preventDefault();
      }
      let cwrap = $("#commentFormWrap");
      if (cwrap) {
        cwrap.parentNode.removeChild(cwrap);
      }
      app.data.commentForm = $("#comment").outerHTML;
      let wrap = document.createElement("div");
      wrap.id = "commentFormWrap";
      wrap.dataset._parent = pid;
      wrap.innerHTML = app.data.commentForm;
      wrap.querySelector("#comment").id = "reply";
      
      who.parentNode.append(wrap);

      return false;
    },
    display(data, tgt) {
      let out = "<table><thead><tr>";
      const keys = Object.keys(data[0]);
      if (keys) {
          keys.forEach(key => {
              out += `<th>${key}</th>`;
          });
      }
      out += "</tr></thead><tbody>";
      data.forEach(item=>{
          out += `<tr>`;
          keys.forEach(key => {
              out += `<td>${item[i]}</td>`;
          });
          out += `</tr>`;
      });
      out += "</tbody></table>";

      if (tgt) {
        tgt.innerHTML = out;
      }
      return out;
    },
    cancelComment(who, evt) {
      let el = who.closest(".commentFormWrap");
      if (el) {
        el.parentNode.removeChild(el);
      }
    }
  }
  window.app = app;
  app.init();
})();
</script>
</body>
</html>
